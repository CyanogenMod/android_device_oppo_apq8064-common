From d78852fb29ba8af59f129773b7ec5cb81a1c607e Mon Sep 17 00:00:00 2001
From: wuxianlin <wuxianlinwxl@gmail.com>
Date: Sun, 12 Apr 2015 21:58:51 +0800
Subject: [PATCH] lvm storage

---
 core/res/res/xml/storage_list_lvm.xml              |   28 ++++++++++++++++++++
 .../core/java/com/android/server/MountService.java |    7 +++++
 2 files changed, 35 insertions(+)
 create mode 100644 core/res/res/xml/storage_list_lvm.xml

diff --git a/core/res/res/xml/storage_list_lvm.xml b/core/res/res/xml/storage_list_lvm.xml
new file mode 100644
index 0000000..ceebdcc
--- /dev/null
+++ b/core/res/res/xml/storage_list_lvm.xml
@@ -0,0 +1,28 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+**
+** Copyright 2011, The Android Open Source Project
+**
+** Licensed under the Apache License, Version 2.0 (the "License")
+** you may not use this file except in compliance with the License.
+** You may obtain a copy of the License at
+**
+**     http://www.apache.org/licenses/LICENSE-2.0
+**
+** Unless required by applicable law or agreed to in writing, software
+** distributed under the License is distributed on an "AS IS" BASIS,
+** WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+** See the License for the specific language governing permissions and
+** limitations under the License.
+*/
+-->
+
+<!-- See storage config details at http://source.android.com/tech/storage/ -->
+
+<StorageList xmlns:android="http://schemas.android.com/apk/res/android">
+    <!-- removable is not set in nosdcard product -->
+    <storage
+        android:mountPoint="/storage/sdcard"
+        android:storageDescription="@string/storage_usb"
+        android:primary="true" />
+</StorageList>
diff --git a/services/core/java/com/android/server/MountService.java b/services/core/java/com/android/server/MountService.java
index fa1e21b..99437dc 100644
--- a/services/core/java/com/android/server/MountService.java
+++ b/services/core/java/com/android/server/MountService.java
@@ -1366,7 +1366,14 @@ class MountService extends IMountService.Stub
         Resources resources = mContext.getResources();
 
         int id = com.android.internal.R.xml.storage_list;
+        String pkg = mContext.getPackageName();
+        int idLvm = resources.getIdentifier("storage_list_lvm", "xml", pkg);
+        String lvm = SystemProperties.get("ro.lvm_storage", "0");
         XmlResourceParser parser = resources.getXml(id);
+        if ((lvm.equals("1") || lvm.equalsIgnoreCase("true")) && idLvm != 0) {
+            parser = resources.getXml(idLvm);
+            Slog.i(TAG, "readStorageListLocked: using LVM storage list");
+        }
         AttributeSet attrs = Xml.asAttributeSet(parser);
 
         try {
-- 
1.7.9.5

